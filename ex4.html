<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Exerc√≠cio 4</title>
    <!-- include three.js library -->
    <script src='js/three.min.js'></script>
    <script src='js/GLTF2Loader.js'></script>
    <!-- include jsartookit -->
    <script src="jsartoolkit5/artoolkit.min.js"></script>
    <script src="jsartoolkit5/artoolkit.api.js"></script>
    <!-- include threex.artoolkit -->
    <script src="threex/threex-artoolkitsource.js"></script>
    <script src="threex/threex-artoolkitcontext.js"></script>
    <script src="threex/threex-arbasecontrols.js"></script>
    <script src="threex/threex-armarkercontrols.js"></script>
</head>
<body>
<script>
    var scene, camera, renderer, clock, deltaTime, totalTime;

    var arToolkitSource, arToolkitContext;

    let markerRoot1, markerRoot2, markerRoot3, markerRoot4, markerRoot5;
    let markerControls1, markerControls2, markerControls3, markerControls4, markerControls5;

    let markerLetterA, markerLetterB, markerLetterC, markerLetterD, markerLetterF, markerLetterG;
    let markerControlsA, markerControlsB, markerControlsC, markerControlsD, markerControlsF, markerControlsG;

    let sceneGroupModel = new THREE.Group();
    let sceneGroupModel1 = new THREE.Group();
    let sceneGroupModel2 = new THREE.Group();
    let sceneGroupModel3 = new THREE.Group();
    let sceneGroupModel4 = new THREE.Group();
    let sceneGroupModel5 = new THREE.Group();

    const mixers = [];
    let gltf;

    initialize();
    animate();

    function initialize() {
        scene = new THREE.Scene();

        camera = new THREE.Camera();
        scene.add(camera);

        renderer = new THREE.WebGLRenderer({
            antialias : true,
            alpha: true
        });
        renderer.setClearColor(new THREE.Color('lightgrey'), 0)
        renderer.setSize( 640, 480 );
        renderer.domElement.style.position = 'absolute';
        renderer.domElement.style.top = '0px';
        renderer.domElement.style.left = '0px';
        document.body.appendChild( renderer.domElement );

        clock = new THREE.Clock();
        deltaTime = 0;
        totalTime = 0;

        ////////////////////////////////////////////////////////////
        // setup arToolkitSource
        ////////////////////////////////////////////////////////////

        arToolkitSource = new THREEx.ArToolkitSource({
            sourceType : 'webcam',
        });

        function onResize()
        {
            arToolkitSource.onResizeElement();
            arToolkitSource.copyElementSizeTo(renderer.domElement);
            if ( arToolkitContext.arController !== null )
            {
                arToolkitSource.copySizeTo(arToolkitContext.arController.canvas);
            }
        }

        arToolkitSource.init(function onReady(){
            onResize()
        });

        // handle resize event
        window.addEventListener('resize', function(){
            onResize()
        });

        ////////////////////////////////////////////////////////////
        // setup arToolkitContext
        ////////////////////////////////////////////////////////////

        // create atToolkitContext
        arToolkitContext = new THREEx.ArToolkitContext({
            cameraParametersUrl: 'data/camera_para.dat',
            detectionMode: 'mono'
        });

        // copy projection matrix to camera when initialization complete
        arToolkitContext.init( function onCompleted(){
            camera.projectionMatrix.copy( arToolkitContext.getProjectionMatrix() );
        });

        ////////////////////////////////////////////////////////////
        // setup markerRoots
        ////////////////////////////////////////////////////////////

        // build markerControls
        markerRoot1 = new THREE.Group();
        scene.add(markerRoot1);
        markerControls1 = new THREEx.ArMarkerControls(arToolkitContext, markerRoot1, {
            type: 'pattern', patternUrl: "data/1.patt",
        });

        markerRoot2 = new THREE.Group();
        scene.add(markerRoot2);
        markerControls2 = new THREEx.ArMarkerControls(arToolkitContext, markerRoot2, {
            type: 'pattern', patternUrl: "data/2.patt",
        });

        markerRoot3 = new THREE.Group();
        scene.add(markerRoot3);
        markerControls3 = new THREEx.ArMarkerControls(arToolkitContext, markerRoot3, {
            type: 'pattern', patternUrl: "data/3.patt",
        });

        markerRoot4 = new THREE.Group();
        scene.add(markerRoot4);
        markerControls4 = new THREEx.ArMarkerControls(arToolkitContext, markerRoot4, {
            type: 'pattern', patternUrl: "data/4.patt",
        });

        markerRoot5 = new THREE.Group();
        scene.add(markerRoot5);
        markerControls5 = new THREEx.ArMarkerControls(arToolkitContext, markerRoot5, {
            type: 'pattern', patternUrl: "data/5.patt",
        });

        markerLetterA = new THREE.Group();
        markerControlsA = new THREEx.ArMarkerControls(arToolkitContext, markerLetterA, {
            type: 'pattern', patternUrl: "data/letterA.patt",
        });

        markerLetterB = new THREE.Group();
        markerControlsB = new THREEx.ArMarkerControls(arToolkitContext, markerLetterB, {
            type: 'pattern', patternUrl: "data/letterB.patt",
        });

        markerLetterC = new THREE.Group();
        markerControlsC = new THREEx.ArMarkerControls(arToolkitContext, markerLetterC, {
            type: 'pattern', patternUrl: "data/letterC.patt",
        });

        markerLetterD = new THREE.Group();
        markerControlsD = new THREEx.ArMarkerControls(arToolkitContext, markerLetterD, {
            type: 'pattern', patternUrl: "data/letterD.patt",
        });

        markerLetterG = new THREE.Group();
        markerControlsG = new THREEx.ArMarkerControls(arToolkitContext, markerLetterG, {
            type: 'pattern', patternUrl: "data/letterG.patt",
        });

        markerLetterF = new THREE.Group();
        markerControlsF = new THREEx.ArMarkerControls(arToolkitContext, markerLetterF, {
            type: 'pattern', patternUrl: "data/letterF.patt",
        });

        ////////////////////////////////////////////////////////////
        // setup scene
        ////////////////////////////////////////////////////////////

        let light = new THREE.PointLight( 0xffffff, 1, 100 );
        light.position.set( 0,4,0 ); // default; light shining from top
        light.castShadow = true;
        camera.add( light );

        const loader = new THREE.GLTF2Loader();
        loader.load(
            'models/BrainStem.gltf',
            ( gltf ) => {
                // called when the resource is loaded
                gltf.scene.name = 'brainStem';
                const mixer = new THREE.AnimationMixer(gltf.scene);
                // animations is a list of THREE.AnimationClip
                for (const anim of gltf.animations) {
                    mixer.clipAction(anim).play();
                }
                sceneGroupModel1.add( gltf.scene );
                mixers.push(mixer);
            },
            ( xhr ) => {
                // called while loading is progressing
                console.log( `${( xhr.loaded / xhr.total * 100 )}% loaded` );
            },
            ( error ) => {
                // called when loading has errors
                console.error( 'An error happened', error );
            },
        );

        loader.load(
            'models/CesiumMan.gltf',
            ( gltf ) => {
                // called when the resource is loaded
                gltf.scene.name = 'cesiumMan';
                const mixer = new THREE.AnimationMixer(gltf.scene);
                // animations is a list of THREE.AnimationClip
                for (const anim of gltf.animations) {
                    mixer.clipAction(anim).play();
                }
                sceneGroupModel2.add( gltf.scene );
                mixers.push(mixer);
            },
            ( xhr ) => {
                // called while loading is progressing
                console.log( `${( xhr.loaded / xhr.total * 100 )}% loaded` );
            },
            ( error ) => {
                // called when loading has errors
                console.error( 'An error happened', error );
            },
        );

        loader.load(
            'models/CesiumMilkTruck.gltf',
            ( gltf ) => {
                // called when the resource is loaded
                gltf.scene.name = 'cesiumTruck';
                const mixer = new THREE.AnimationMixer(gltf.scene);
                // animations is a list of THREE.AnimationClip
                for (const anim of gltf.animations) {
                    mixer.clipAction(anim).play();
                }
                sceneGroupModel3.add( gltf.scene );
                mixers.push(mixer);
            },
            ( xhr ) => {
                // called while loading is progressing
                console.log( `${( xhr.loaded / xhr.total * 100 )}% loaded` );
            },
            ( error ) => {
                // called when loading has errors
                console.error( 'An error happened', error );
            },
        );

        loader.load(
            'models/BarramundiFish.glb',
            ( gltf ) => {
                // called when the resource is loaded
                gltf.scene.name = 'monster';
                const mixer = new THREE.AnimationMixer(gltf.scene);
                // animations is a list of THREE.AnimationClip
                for (const anim of gltf.animations) {
                    mixer.clipAction(anim).play();
                }
                gltf.scene.scale.set(10,10,10);
                gltf.scene.rotation.y = Math.PI/2;
                sceneGroupModel4.add( gltf.scene );
                mixers.push(mixer);
            },
            ( xhr ) => {
                // called while loading is progressing
                console.log( `${( xhr.loaded / xhr.total * 100 )}% loaded` );
            },
            ( error ) => {
                // called when loading has errors
                console.error( 'An error happened', error );
            },
        );

        loader.load(
            'models/RiggedFigure.gltf',
            ( gltf ) => {
                // called when the resource is loaded
                gltf.scene.name = 'rigged';
                const mixer = new THREE.AnimationMixer(gltf.scene);
                // animations is a list of THREE.AnimationClip
                for (const anim of gltf.animations) {
                    mixer.clipAction(anim).play();
                }
                sceneGroupModel5.add( gltf.scene );
                mixers.push(mixer);
            },
            ( xhr ) => {
                // called while loading is progressing
                console.log( `${( xhr.loaded / xhr.total * 100 )}% loaded` );
            },
            ( error ) => {
                // called when loading has errors
                console.error( 'An error happened', error );
            },
        );
    }
    function animate()
    {
        var mixerUpdateDelta = clock.getDelta();
        // Update all the animation frames
        for ( var i = 0; i < mixers.length; ++ i ) {
            mixers[ i ].update( mixerUpdateDelta );
        }
        requestAnimationFrame(animate);
        update();
        render();
    }

    function update()
    {
        if(markerControls1.object3d.visible){
            //console.log("kanjiii");
            markerLetterA.remove(sceneGroupModel);
            markerLetterB.remove(sceneGroupModel);
            markerLetterC.remove(sceneGroupModel);
            markerLetterD.remove(sceneGroupModel);
            markerLetterF.remove(sceneGroupModel);
            markerLetterG.remove(sceneGroupModel);

            sceneGroupModel = sceneGroupModel1;

            if(markerControlsA.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('brainStem').position.set(2.5,0,1);
                markerLetterA.add( sceneGroupModel );
                scene.add(markerLetterA);
            }

            else if(markerControlsB.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('brainStem').position.set(0,0,1);
                markerLetterB.add( sceneGroupModel );
                scene.add(markerLetterB);
            }

            else if(markerControlsC.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('brainStem').position.set(-2.5,0,1);
                markerLetterC.add( sceneGroupModel );
                scene.add(markerLetterC);
            }

            else if(markerControlsD.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('brainStem').position.set(2.5,0,-1);
                markerLetterD.add( sceneGroupModel );
                scene.add(markerLetterD);
            }

            else if(markerControlsF.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('brainStem').position.set(-2.5,0,-1);
                markerLetterF.add( sceneGroupModel );
                scene.add(markerLetterF);
            }

            else if(markerControlsG.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('brainStem').position.set(0,0,-1);
                markerLetterG.add( sceneGroupModel );
                scene.add(markerLetterG);
            }
        }
        else if(markerControls2.object3d.visible){
            //console.log("kanjiii");
            markerLetterA.remove(sceneGroupModel);
            markerLetterB.remove(sceneGroupModel);
            markerLetterC.remove(sceneGroupModel);
            markerLetterD.remove(sceneGroupModel);
            markerLetterF.remove(sceneGroupModel);
            markerLetterG.remove(sceneGroupModel);

            sceneGroupModel = sceneGroupModel2;

            if(markerControlsA.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('cesiumMan').position.set(2.5,0,1);
                markerLetterA.add( sceneGroupModel );
                scene.add(markerLetterA);
            }

            else if(markerControlsB.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('cesiumMan').position.set(0,0,1);
                markerLetterB.add( sceneGroupModel );
                scene.add(markerLetterB);
            }

            else if(markerControlsC.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('cesiumMan').position.set(-2.5,0,1);
                markerLetterC.add( sceneGroupModel );
                scene.add(markerLetterC);
            }

            else if(markerControlsD.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('cesiumMan').position.set(2.5,0,-1);
                markerLetterD.add( sceneGroupModel );
                scene.add(markerLetterD);
            }

            else if(markerControlsF.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('cesiumMan').position.set(-2.5,0,-1);
                markerLetterF.add( sceneGroupModel );
                scene.add(markerLetterF);
            }

            else if(markerControlsG.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('cesiumMan').position.set(0,0,-1);
                markerLetterG.add( sceneGroupModel );
                scene.add(markerLetterG);
            }
        }
        else if(markerControls3.object3d.visible){
            //console.log("kanjiii");
            markerLetterA.remove(sceneGroupModel);
            markerLetterB.remove(sceneGroupModel);
            markerLetterC.remove(sceneGroupModel);
            markerLetterD.remove(sceneGroupModel);
            markerLetterF.remove(sceneGroupModel);
            markerLetterG.remove(sceneGroupModel);

            sceneGroupModel = sceneGroupModel3;

            if(markerControlsA.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('cesiumTruck').position.set(2.5,0,1);
                markerLetterA.add( sceneGroupModel );
                scene.add(markerLetterA);
            }

            else if(markerControlsB.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('cesiumTruck').position.set(0,0,1);
                markerLetterB.add( sceneGroupModel );
                scene.add(markerLetterB);
            }

            else if(markerControlsC.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('cesiumTruck').position.set(-2.5,0,1);
                markerLetterC.add( sceneGroupModel );
                scene.add(markerLetterC);
            }

            else if(markerControlsD.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('cesiumTruck').position.set(2.5,0,-1);
                markerLetterD.add( sceneGroupModel );
                scene.add(markerLetterD);
            }

            else if(markerControlsF.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('cesiumTruck').position.set(-2.5,0,-1);
                markerLetterF.add( sceneGroupModel );
                scene.add(markerLetterF);
            }

            else if(markerControlsG.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('cesiumTruck').position.set(0,0,-1);
                markerLetterG.add( sceneGroupModel );
                scene.add(markerLetterG);
            }
        }
        else if(markerControls4.object3d.visible){
            //console.log("kanjiii");
            markerLetterA.remove(sceneGroupModel);
            markerLetterB.remove(sceneGroupModel);
            markerLetterC.remove(sceneGroupModel);
            markerLetterD.remove(sceneGroupModel);
            markerLetterF.remove(sceneGroupModel);
            markerLetterG.remove(sceneGroupModel);

            sceneGroupModel = sceneGroupModel4;

            if(markerControlsA.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('monster').position.set(2.5,0,1);
                markerLetterA.add( sceneGroupModel );
                scene.add(markerLetterA);
            }

            else if(markerControlsB.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('monster').position.set(0,0,1);
                markerLetterB.add( sceneGroupModel );
                scene.add(markerLetterB);
            }

            else if(markerControlsC.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('monster').position.set(-2.5,0,1);
                markerLetterC.add( sceneGroupModel );
                scene.add(markerLetterC);
            }

            else if(markerControlsD.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('monster').position.set(2.5,0,-1);
                markerLetterD.add( sceneGroupModel );
                scene.add(markerLetterD);
            }

            else if(markerControlsF.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('monster').position.set(-2.5,0,-1);
                markerLetterF.add( sceneGroupModel );
                scene.add(markerLetterF);
            }

            else if(markerControlsG.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('monster').position.set(0,0,-1);
                markerLetterG.add( sceneGroupModel );
                scene.add(markerLetterG);
            }
        }
        else if(markerControls5.object3d.visible){
            //console.log("kanjiii");
            markerLetterA.remove(sceneGroupModel);
            markerLetterB.remove(sceneGroupModel);
            markerLetterC.remove(sceneGroupModel);
            markerLetterD.remove(sceneGroupModel);
            markerLetterF.remove(sceneGroupModel);
            markerLetterG.remove(sceneGroupModel);

            sceneGroupModel = sceneGroupModel5;

            if(markerControlsA.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('rigged').position.set(2.5,0,1);
                markerLetterA.add( sceneGroupModel );
                scene.add(markerLetterA);
            }

            else if(markerControlsB.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('rigged').position.set(0,0,1);
                markerLetterB.add( sceneGroupModel );
                scene.add(markerLetterB);
            }

            else if(markerControlsC.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('rigged').position.set(-2.5,0,1);
                markerLetterC.add( sceneGroupModel );
                scene.add(markerLetterC);
            }

            else if(markerControlsD.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('rigged').position.set(2.5,0,-1);
                markerLetterD.add( sceneGroupModel );
                scene.add(markerLetterD);
            }

            else if(markerControlsF.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('rigged').position.set(-2.5,0,-1);
                markerLetterF.add( sceneGroupModel );
                scene.add(markerLetterF);
            }

            else if(markerControlsG.object3d.visible){
                var obj = sceneGroupModel.getObjectByName('rigged').position.set(0,0,-1);
                markerLetterG.add( sceneGroupModel );
                scene.add(markerLetterG);
            }
        }
        else{
            //console.log("fora");
            scene.remove(markerLetterA);
            scene.remove(markerLetterB);
            scene.remove(markerLetterC);
            scene.remove(markerLetterD);
            scene.remove(markerLetterG);
            scene.remove(markerLetterF);
        }
        // update artoolkit on every frame
        if ( arToolkitSource.ready !== false )
            arToolkitContext.update( arToolkitSource.domElement );
    }

    function render()
    {
        renderer.render( scene, camera );
    }
</script>
</body>
</html>